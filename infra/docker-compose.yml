services:
  postgres:
    image: postgres:16
    container_name: heyanon_postgres
    environment:
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_DB: anon
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 5s

  redis:
    image: redis:7
    container_name: heyanon_redis
    ports:
      - "6379:6379"
    restart: unless-stopped

  api:
    build: ../api
    image: heyanon_api:ci
    container_name: heyanon_api
    env_file:
      - ../api/.env
    environment:
      - API_SHARED_SECRET=supersecret
      - API_KEY=supersecret
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import sys,urllib.request;print(urllib.request.urlopen('http://localhost:8000/health', timeout=3).read());sys.exit(0)"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s
    restart: unless-stopped

  web:
    build: ../web
    container_name: heyanon_web
    environment:
      NEXT_PUBLIC_API_BASE_URL: http://localhost:8000
    ports:
      - "3000:3000"
    depends_on:
      - api
    restart: unless-stopped

  bot:
    build:
      context: ../bot
    image: heyanon_bot:ci
    container_name: heyanon_bot
    depends_on:
      api:
        condition: service_healthy
    environment:
      - BASE_URL=http://api:8000
      - STRATEGY_ID=mtf-btc-1h-6h-16h
      - SYMBOL=BTC-PERP
      - HEYANON_API_KEY=supersecret
      - API_SHARED_SECRET=supersecret
      - SEND_TEST_TRADE=0
      - SNAPSHOT_INTERVAL_SEC=30
    volumes:
      - ../bot_data:/data:rw
    restart: unless-stopped

  prometheus:
    # pin to a known-good Prometheus tag for local dev
    image: prom/prometheus:v2.53.0
    container_name: heyanon_prometheus
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus_rules.yml:/etc/prometheus/prometheus_rules.yml:ro
      - ./prometheus_rules_new.yml:/etc/prometheus/prometheus_rules_new.yml:ro
    ports:
      - "9090:9090"
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.1.0
    container_name: heyanon_grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
      - ./grafana/dashboards:/var/lib/grafana/dashboards:ro
    # Host port moved to 3001 so it doesn't conflict with the web frontend (3000)
    ports:
      - "3001:3000"
    depends_on:
      - prometheus
    restart: unless-stopped

  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: heyanon_alertmanager
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
    ports:
      - "9093:9093"
    restart: unless-stopped

  discord-relay:
    image: python:3.11-slim
    container_name: heyanon_discord_relay
    working_dir: /app
    volumes:
      - ./discord_relay:/app:ro
    environment:
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
    command: sh -lc "pip install --no-cache-dir flask requests && python app.py"
    restart: unless-stopped
    depends_on:
      - alertmanager

  copy-executor:
    build:
      context: ../executor
    image: heyanon_copy_executor:ci
    container_name: heyanon_copy_executor
    environment:
      - API_BASE=http://api:8000
      - POLL_INTERVAL=10
      - DISABLE_COPY=1  # set to 0 to enable
      # comma-separated strategies list for multi-strategy executor
      - STRATEGIES=mtf-btc-1h-6h-16h,mtf-eth-1h-6h-16h,swing-perp-16h
      - COPY_METRICS_PORT=9102
    depends_on:
      - api
    ports:
      - "9102:9102"
    restart: unless-stopped

  # --- additional bots to run in parallel ---
  bot-mtf-eth:
    build:
      context: ../bot
    container_name: heyanon_bot_mtf_eth
    environment:
      - BASE_URL=http://api:8000
      - STRATEGY_ID=mtf-eth-1h-6h-16h
      - SYMBOL=ETH-PERP
      - HEYANON_API_KEY=supersecret
      - API_SHARED_SECRET=supersecret
      - SNAPSHOT_INTERVAL_SEC=30
    depends_on:
      - api
    restart: unless-stopped

  bot-swing-btc:
    build:
      context: ../bot
    container_name: heyanon_bot_swing_btc
    environment:
      - BASE_URL=http://api:8000
      - STRATEGY_ID=swing-perp-16h
      - SYMBOL=BTC-PERP
      - HEYANON_API_KEY=supersecret
      - API_SHARED_SECRET=supersecret
      - SNAPSHOT_INTERVAL_SEC=30
    depends_on:
      - api
    restart: unless-stopped

  bot-levx-btc:
    build:
      context: ../bot
    container_name: heyanon_bot_levx_btc
    environment:
      - BASE_URL=http://api:8000
      - STRATEGY_ID=levx-btc-1h
      - SYMBOL=BTC-PERP
      - HEYANON_API_KEY=supersecret
      - API_SHARED_SECRET=supersecret
      - SNAPSHOT_INTERVAL_SEC=60
    depends_on:
      - api
    restart: unless-stopped

  # Per-strategy copy-executor instances removed; use single multi-strategy `copy-executor` above.

volumes:
  pgdata: